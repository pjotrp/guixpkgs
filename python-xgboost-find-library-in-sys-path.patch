From 89afbdfab81f8547613d02f3efb22e430744c82f Mon Sep 17 00:00:00 2001
From: fis <ybbs.daans@hotmail.com>
Date: Tue, 29 May 2018 03:31:33 +0800
Subject: [PATCH] Find library in sys.path

---
 python-package/MANIFEST.in |  6 ------
 python-package/setup.py    | 30 ++++++++++++++++++++++++------
 2 files changed, 24 insertions(+), 12 deletions(-)

diff --git a/python-package/MANIFEST.in b/python-package/MANIFEST.in
index 38b1a77a..bd180edf 100644
--- a/python-package/MANIFEST.in
+++ b/python-package/MANIFEST.in
@@ -1,11 +1,5 @@
 include *.md *.rst
 recursive-include xgboost *
-recursive-include xgboost/include *
-recursive-include xgboost/src *
-recursive-include xgboost/make *
-recursive-include xgboost/rabit *
-recursive-include xgboost/lib *
-recursive-include xgboost/dmlc-core *
 #exclude pre-compiled .o and .a file for less confusions
 #make sure .a files are all removed for forcing compiling
 #include the pre-compiled .so is needed as a placeholder
diff --git a/python-package/setup.py b/python-package/setup.py
index e6c3386f..5762ab51 100644
--- a/python-package/setup.py
+++ b/python-package/setup.py
@@ -4,7 +4,6 @@ from __future__ import absolute_import
 import sys
 import os
 from setuptools import setup, find_packages
-# import subprocess
 sys.path.insert(0, '.')
 
 CURRENT_DIR = os.path.dirname(__file__)
@@ -12,14 +11,33 @@ CURRENT_DIR = os.path.dirname(__file__)
 # We can not import `xgboost.libpath` in setup.py directly since xgboost/__init__.py
 # import `xgboost.core` and finally will import `numpy` and `scipy` which are setup
 # `install_requires`. That's why we're using `exec` here.
-libpath_py = os.path.join(CURRENT_DIR, 'xgboost/libpath.py')
-libpath = {'__file__': libpath_py}
-exec(compile(open(libpath_py, "rb").read(), libpath_py, 'exec'), libpath, libpath)
+# libpath_py = os.path.join(CURRENT_DIR, 'xgboost/libpath.py')
+# libpath = {'__file__': libpath_py}
+# exec(compile(open(libpath_py, "rb").read(), libpath_py, 'exec'), libpath, libpath)
+
+# LIB_PATH = [os.path.relpath(libfile, CURRENT_DIR) for libfile in libpath['find_lib_path']()]
+# print("Install libxgboost from: %s" % LIB_PATH)
 
-LIB_PATH = [os.path.relpath(libfile, CURRENT_DIR) for libfile in libpath['find_lib_path']()]
-print("Install libxgboost from: %s" % LIB_PATH)
 # Please use setup_pip.py for generating and deploying pip installation
 # detailed instruction in setup_pip.py
+def find_lib():
+    def _find (name, path):
+        for root, dirs, files in os.walk(path):
+            if name in files:
+                return os.path.join(root, name)
+
+    LIBRARY_PATH = os.environ['LIBRARY_PATH']
+    LIBRARY_PATH = LIBRARY_PATH.split(':')
+    print(LIBRARY_PATH)
+    for p in LIBRARY_PATH:
+        result = _find('libxgboost.so', p)
+        if result is not None:
+            return [result]
+    raise ValueError('Library not found.')
+
+LIB_PATH = find_lib()
+print('lib_path: ', LIB_PATH)
+
 setup(name='xgboost',
       version=open(os.path.join(CURRENT_DIR, 'xgboost/VERSION')).read().strip(),
       description="XGBoost Python Package",
-- 
2.14.3

